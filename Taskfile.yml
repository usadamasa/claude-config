version: '3'

includes:
  go:
    taskfile: ./cmd/Taskfile.yml
    optional: true

tasks:
  test:
    desc: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ (bats + Go + shellcheck)
    cmds:
      - echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
      - task: shellcheck
      - bats tests/
      - task: go:test
      - echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"

  shellcheck:
    desc: å…¨ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã® shellcheck ã‚’å®Ÿè¡Œ
    cmds:
      - find . \( -name "*.sh" -o -name "*.bats" -o -name ".envrc" \) -not -path "./.git/*" | xargs shellcheck

  install-hooks:
    desc: pre-commit ã® git hooks ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - |
        if ! command -v pre-commit &>/dev/null; then
          echo "â­ï¸ pre-commit ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          exit 0
        fi
        GIT_DIR=$(git rev-parse --git-dir 2>/dev/null)
        GIT_COMMON=$(git rev-parse --git-common-dir 2>/dev/null)
        if [ "$GIT_DIR" != "$GIT_COMMON" ]; then
          # worktree ç’°å¢ƒ: core.hooksPath ã§å…±é€šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
          HOOKS_DIR="$GIT_COMMON/hooks"
          git config core.hooksPath "$HOOKS_DIR"
          pre-commit install --hook-type pre-commit --install-hooks
          echo "  âœ“ pre-commit hooks installed (worktree: $HOOKS_DIR)"
        else
          pre-commit install --install-hooks
          echo "  âœ“ pre-commit hooks installed"
        fi

  setup:
    desc: Claudeè¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ãƒ™ãƒ« symlink ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    deps: [build:hooks-bin]
    cmds:
      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª symlink â†’ å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      - |
        if [ -L "$HOME/.claude" ]; then
          echo "ğŸ”„ ~/.claude ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª symlink ã‹ã‚‰å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»è¡Œä¸­..."
          OLD_TARGET=$(readlink "$HOME/.claude")
          case "$OLD_TARGET" in
            /*) ;;
            *)  OLD_TARGET="$(cd "$(dirname "$HOME/.claude")" && cd "$OLD_TARGET" && pwd)" ;;
          esac
          rm "$HOME/.claude"
          cp -a "$OLD_TARGET" "$HOME/.claude"
          echo "  ğŸ“¦ å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: $OLD_TARGET â†’ $HOME/.claude"
        fi
      - mkdir -p "$HOME/.claude/skills"
      # CLAUDE-global.md â†’ ~/.claude/CLAUDE.md (åå‰ãŒç•°ãªã‚‹ç‰¹æ®Šãƒãƒƒãƒ”ãƒ³ã‚°)
      - |
        if [ -f "{{.TASKFILE_DIR}}/dotclaude/CLAUDE-global.md" ]; then
          ln -sfn "{{.TASKFILE_DIR}}/dotclaude/CLAUDE-global.md" "$HOME/.claude/CLAUDE.md"
          echo "  âœ“ CLAUDE-global.md â†’ CLAUDE.md"
        fi
      # dotclaude/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã® symlink
      - |
        for file in dotclaude/settings.json dotclaude/env.sh; do
          if [ -f "{{.TASKFILE_DIR}}/$file" ]; then
            basename=$(basename "$file")
            ln -sfn "{{.TASKFILE_DIR}}/$file" "$HOME/.claude/$basename"
            echo "  âœ“ $basename"
          fi
        done
      # dotclaude/ é…ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® symlink
      - |
        for dir in dotclaude/hooks dotclaude/bin; do
          if [ -d "{{.TASKFILE_DIR}}/$dir" ]; then
            basename=$(basename "$dir")
            target="$HOME/.claude/$basename"
            if [ -d "$target" ] && [ ! -L "$target" ]; then
              rm -rf "$target"
            fi
            ln -sfn "{{.TASKFILE_DIR}}/$dir" "$target"
            echo "  âœ“ $basename/"
          fi
        done
      # dotclaude/skills/ é…ä¸‹ã®å…¨ã‚¹ã‚­ãƒ«ã‚’è‡ªå‹•æ¤œå‡º & symlink
      - |
        for skill_dir in "{{.TASKFILE_DIR}}/dotclaude/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          target="$HOME/.claude/skills/$skill_name"
          if [ -d "$target" ] && [ ! -L "$target" ]; then
            rm -rf "$target"
          fi
          ln -sfn "$skill_dir" "$target"
          echo "  âœ“ skills/$skill_name/"
        done
      - task: install-hooks
      - echo "âœ… Claudeè¨­å®šã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"

  status:
    desc: Claudeè¨­å®šã®çŠ¶æ…‹ã‚’ç¢ºèª
    cmds:
      - |
        echo "Claudeè¨­å®š:"
        echo "  ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(test -d "$HOME/.claude" && ! test -L "$HOME/.claude" && echo 'âœ“ å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª' || echo 'âœ—')"
        echo "  CLAUDE.md (â† CLAUDE-global.md): $(test -L "$HOME/.claude/CLAUDE.md" && echo 'âœ“' || echo 'âœ—')"
        echo "  settings.json: $(test -L "$HOME/.claude/settings.json" && echo 'âœ“' || echo 'âœ—')"
        echo "  hooks: $(test -L "$HOME/.claude/hooks" && echo 'âœ“' || echo 'âœ—')"
        echo "  bin: $(test -L "$HOME/.claude/bin" && echo 'âœ“' || echo 'âœ—')"
        echo "  env.sh: $(test -L "$HOME/.claude/env.sh" && echo 'âœ“' || echo 'âœ—')"
        echo "  skills:"
        for skill_dir in "{{.TASKFILE_DIR}}/dotclaude/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          echo "    $skill_name: $(test -L "$HOME/.claude/skills/$skill_name" && echo 'âœ“' || echo 'âœ—')"
        done

  clean:
    desc: Claudeè¨­å®šã® symlink ã‚’å‰Šé™¤
    cmds:
      - rm -f "$HOME/.claude/CLAUDE.md" "$HOME/.claude/settings.json" "$HOME/.claude/env.sh"
      - |
        for dir in hooks bin; do
          target="$HOME/.claude/$dir"
          if [ -L "$target" ]; then
            rm -f "$target"
          elif [ -d "$target" ]; then
            rm -rf "$target"
          fi
        done
      - |
        for skill_dir in "{{.TASKFILE_DIR}}/dotclaude/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          target="$HOME/.claude/skills/$skill_name"
          if [ -L "$target" ]; then
            rm -f "$target"
          elif [ -d "$target" ]; then
            rm -rf "$target"
          fi
        done
      - echo "ğŸ—‘ï¸ Claudeè¨­å®šã® symlink ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

  build:hooks-bin:
    desc: ãƒ•ãƒƒã‚¯ãŒä½¿ã† Go ãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ (ãƒ›ã‚¹ãƒˆç”¨)
    cmds:
      - mkdir -p dotclaude/bin
      - go build -o dotclaude/bin/realpath ./cmd/realpath
      - go build -o dotclaude/bin/guard-home-dir ./cmd/guard-home-dir
    sources:
      - cmd/realpath/*.go
      - cmd/guard-home-dir/*.go
    generates:
      - dotclaude/bin/realpath
      - dotclaude/bin/guard-home-dir

  build:docker-bin:
    desc: Docker (Linux) ç”¨ Go ãƒã‚¤ãƒŠãƒªã‚’ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    cmds:
      - mkdir -p docker/bin
      - GOOS=linux go build -o docker/bin/realpath ./cmd/realpath
      - GOOS=linux go build -o docker/bin/guard-home-dir ./cmd/guard-home-dir
      - GOOS=linux go build -o docker/bin/analyze-permissions ./cmd/analyze-permissions
      - GOOS=linux go build -o docker/bin/analyze-webfetch ./cmd/analyze-webfetch
      - GOOS=linux go build -o docker/bin/analyze-tokens ./cmd/analyze-tokens
    sources:
      - cmd/realpath/*.go
      - cmd/guard-home-dir/*.go
      - cmd/analyze-permissions/*.go
      - cmd/analyze-webfetch/*.go
      - cmd/analyze-tokens/*.go
    generates:
      - docker/bin/realpath
      - docker/bin/guard-home-dir
      - docker/bin/analyze-permissions
      - docker/bin/analyze-webfetch
      - docker/bin/analyze-tokens

  docker:verify:
    desc: Dockerã‚³ãƒ³ãƒ†ãƒŠã§ç¾åœ¨ã®claude-configè¨­å®šã‚’æ¤œè¨¼
    deps: [build:docker-bin]
    cmds:
      - ./docker/verify.sh {{.CLI_ARGS}}

  docker:clean:
    desc: æ¤œè¨¼ç”¨Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
    cmds:
      - docker image rm -f claude-config-verify || true
      - docker volume rm claude-config-verify-local || true
      - docker volume rm claude-config-verify-dotclaude || true
      - rm -rf "${XDG_CACHE_HOME:-$HOME/.cache}/claude-config-verify"
