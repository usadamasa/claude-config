version: '3'

includes:
  go:
    taskfile: ./cmd/Taskfile.yml
    optional: true

tasks:
  test:
    desc: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ (bats + Go)
    cmds:
      - echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
      - bats tests/
      - task: go:test
      - echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"

  setup:
    desc: Claudeè¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ãƒ™ãƒ« symlink ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    cmds:
      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª symlink â†’ å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      - |
        if [ -L "$HOME/.claude" ]; then
          echo "ğŸ”„ ~/.claude ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª symlink ã‹ã‚‰å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»è¡Œä¸­..."
          OLD_TARGET=$(readlink "$HOME/.claude")
          case "$OLD_TARGET" in
            /*) ;;
            *)  OLD_TARGET="$(cd "$(dirname "$HOME/.claude")" && cd "$OLD_TARGET" && pwd)" ;;
          esac
          rm "$HOME/.claude"
          cp -a "$OLD_TARGET" "$HOME/.claude"
          echo "  ğŸ“¦ å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: $OLD_TARGET â†’ $HOME/.claude"
        fi
      - mkdir -p "$HOME/.claude/skills"
      # CLAUDE-global.md â†’ ~/.claude/CLAUDE.md (åå‰ãŒç•°ãªã‚‹ç‰¹æ®Šãƒãƒƒãƒ”ãƒ³ã‚°)
      - |
        if [ -f "{{.TASKFILE_DIR}}/CLAUDE-global.md" ]; then
          ln -sfn "{{.TASKFILE_DIR}}/CLAUDE-global.md" "$HOME/.claude/CLAUDE.md"
          echo "  âœ“ CLAUDE-global.md â†’ CLAUDE.md"
        fi
      # ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã® symlink
      - |
        for file in settings.json env.sh; do
          if [ -f "{{.TASKFILE_DIR}}/$file" ]; then
            ln -sfn "{{.TASKFILE_DIR}}/$file" "$HOME/.claude/$file"
            echo "  âœ“ $file"
          fi
        done
      # ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® symlink
      - |
        for dir in hooks; do
          if [ -d "{{.TASKFILE_DIR}}/$dir" ]; then
            target="$HOME/.claude/$dir"
            if [ -d "$target" ] && [ ! -L "$target" ]; then
              rm -rf "$target"
            fi
            ln -sfn "{{.TASKFILE_DIR}}/$dir" "$target"
            echo "  âœ“ $dir/"
          fi
        done
      # skills/ é…ä¸‹ã®å…¨ã‚¹ã‚­ãƒ«ã‚’è‡ªå‹•æ¤œå‡º & symlink
      - |
        for skill_dir in "{{.TASKFILE_DIR}}/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          target="$HOME/.claude/skills/$skill_name"
          if [ -d "$target" ] && [ ! -L "$target" ]; then
            rm -rf "$target"
          fi
          ln -sfn "$skill_dir" "$target"
          echo "  âœ“ skills/$skill_name/"
        done
      - echo "âœ… Claudeè¨­å®šã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"

  status:
    desc: Claudeè¨­å®šã®çŠ¶æ…‹ã‚’ç¢ºèª
    cmds:
      - |
        echo "Claudeè¨­å®š:"
        echo "  ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(test -d "$HOME/.claude" && ! test -L "$HOME/.claude" && echo 'âœ“ å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª' || echo 'âœ—')"
        echo "  CLAUDE.md (â† CLAUDE-global.md): $(test -L "$HOME/.claude/CLAUDE.md" && echo 'âœ“' || echo 'âœ—')"
        echo "  settings.json: $(test -L "$HOME/.claude/settings.json" && echo 'âœ“' || echo 'âœ—')"
        echo "  hooks: $(test -L "$HOME/.claude/hooks" && echo 'âœ“' || echo 'âœ—')"
        echo "  env.sh: $(test -L "$HOME/.claude/env.sh" && echo 'âœ“' || echo 'âœ—')"
        echo "  skills:"
        for skill_dir in "{{.TASKFILE_DIR}}/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          echo "    $skill_name: $(test -L "$HOME/.claude/skills/$skill_name" && echo 'âœ“' || echo 'âœ—')"
        done

  clean:
    desc: Claudeè¨­å®šã® symlink ã‚’å‰Šé™¤
    cmds:
      - rm -f "$HOME/.claude/CLAUDE.md" "$HOME/.claude/settings.json" "$HOME/.claude/env.sh"
      - |
        target="$HOME/.claude/hooks"
        if [ -L "$target" ]; then
          rm -f "$target"
        elif [ -d "$target" ]; then
          rm -rf "$target"
        fi
      - |
        for skill_dir in "{{.TASKFILE_DIR}}/skills"/*/; do
          [ -d "$skill_dir" ] || continue
          skill_name=$(basename "$skill_dir")
          target="$HOME/.claude/skills/$skill_name"
          if [ -L "$target" ]; then
            rm -f "$target"
          elif [ -d "$target" ]; then
            rm -rf "$target"
          fi
        done
      - echo "ğŸ—‘ï¸ Claudeè¨­å®šã® symlink ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
