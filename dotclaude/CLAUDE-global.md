# Claude Code グローバル設定

> **Note:** 全プロジェクト共通の指示｡原本は [claude-config](https://github.com/usadamasa/claude-config) の `dotclaude/CLAUDE-global.md` で管理｡

## コア原則

- **シンプル第一**: 最小限の変更で目的を達成する｡過剰な設計は避ける｡
- **根本解決**: 一時的な修正は避け、根本原因を追求する｡ハック的修正を見つけたらエレガントな解決を実装する｡
- **影響最小化**: 必要箇所のみ変更し、新規バグの導入を回避する｡
- **検証前提**: 動作を証明できるまでタスクを完了としない｡「スタッフエンジニアはこれを承認するか?」と自問する｡

## 言語・フォーマット

- 会話言語は settings.json の language 設定に従う｡未設定なら日本語で行う｡
- コミットメッセージ、スキル定義などリポジトリに保存されるテキストは標準語で記載する(Config の Language 設定に関わらず)｡
- 半角を使用する文字: 句読点(｡ ､)、括弧(( ) [ ] { })、記号(, : ; ! ?)

## ワークフロー

### 計画 (Plan First)

3ステップ以上またはアーキテクチャ判断を伴うタスクは、実装前に PLAN.md を作成する｡
各ステップを順番に実装し、完了後に [x] でマーク｡

- プランはあくまで「方針」｡実態との乖離に気づいたらプランより実態を優先する｡
- 乖離発見時はユーザーへ確認するか、明らかなプランの誤りなら自分で修正して進める｡

### テスト駆動開発 (TDD)

- まずテストを作成し、失敗を確認する｡
- テストが正しいことを確認したらコミットする｡
- その後、テストをパスする実装を進める｡実装中はテストを変更しない｡
- すべてのテストが通過するまで繰り返す｡

### 自律的バグ修正

- バグレポートを受けたら、質問せずに直接調査・修正する｡ユーザーのコンテキスト切り替えをゼロにする｡

### CI

- CI が失敗したら、進行中タスクに関係なくても **即座に CI 修正に注力** する｡既存問題として無視しない｡
- 全 CI チェック通過を確認してからコミット・タスク再開する｡

### インフラ変更

インフラ変更を提案する前に確認する:

1. デプロイ先 (GCE/GKE/Cloud Run)
2. Org Policy の制約 (パブリック IP、外部アクセス、GCP サービス制限)
3. 認証方式 (service account, IAM, workload identity)
4. 過去の失敗からの既知の制約

## Git 操作

git 操作 (commit, push, PR作成) の前に、必ず以下を実行する:

1. `git rev-parse --git-dir` と `git rev-parse --git-common-dir` を比較して worktree 環境を判定
   - 値が異なる → worktree 環境 / 同じ → 通常リポジトリ
2. worktree 環境: `git config --get remote.origin.fetch` が空なら `git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"` を実行後 `git fetch origin`
3. `gh pr create` は worktree + bare 環境では `--head {branch_name}` を付ける

### 破壊的操作

- `git rebase`, `git reset` は原則使用しない｡必要な場合はユーザー確認を取る｡
- `git stash` より worktree 分離を優先する｡

## セッション管理

### セッション分割

- 1タスク = 1セッション｡タスク完了後は新規セッションを開始する｡
- plan → implement → verify のサイクルを worktree 単位で分離する｡
- コンテキスト蓄積による input tokens 増大を防ぐため、定期的にセッションを区切る｡

### subagent 運用

- 調査・探索はサブエージェントに委譲し、メインコンテキストをクリーンに保つ｡
- 1エージェント = 1タスクの原則で特化性を確保する｡
- タスクの重さに応じてモデルを選択する: 探索は軽量モデル、計画は高性能モデル｡

### 自己改善ループ

- ユーザーから修正・フィードバックを受けたら、そのパターンを auto memory に記録する｡
- 記録フォーマット: `[日付] ミスの内容 → 正しいアプローチ`
- プロジェクトに `tasks/lessons.md` がある場合はそちらに記録する｡

## Shell Script Quality

シェルスクリプト作成・編集時は以下を遵守する:

- `set -euo pipefail` をスクリプト冒頭に記述する
- 変数展開は原則ダブルクォートで囲む (`"$VAR"`)
- `readonly` と代入は分離する (`VAR=$(cmd); readonly VAR`)
- `echo` より `printf '%s\n'` を優先する (引数解釈の制御)
- エラーを `|| true` で握り潰す場合はログ出力を伴う

## ツールとスキル

### 技術調査

- 技術要素やソフトウェアエンジニアリングの調査には subagent `orm-discovery-mcp-go:oreilly-researcher` を積極的に利用する｡

### スキル開発

- <https://code.claude.com/docs/en/skills> を参照し、適切な形式で記述する｡
- 作成後、`/skills` で利用可能か検証する｡
- 配置場所: グローバル(`~/.claude/skills/`) or プロジェクト(`.claude/skills/`)｡
- 特に指示がなければグローバルスコープに配置する｡
